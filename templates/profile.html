{% extends 'base.html' %}

{% block title %}我的 - LovePython{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px; margin: 0 auto;">
    <h2 class="card-title mb-3"><i class="fas fa-user"></i> 我的</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert {% if category == 'error' %}alert-danger{% elif category == 'success' %}alert-success{% else %}alert-info{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="post" enctype="multipart/form-data" id="profileForm">
        <div class="mb-3 text-center">
            <div style="width: 140px; height: 140px; border-radius: 50%; overflow: hidden; margin: 0 auto; border: 3px solid rgba(0,0,0,0.08); background: #f7f9fc; position: relative;">
                <img id="avatarImg" src="{% if avatar_url %}{{ avatar_url }}{% else %}{{ url_for('static', filename='dog_background.svg') }}{% endif %}" alt="头像" style="width: 100%; height: 100%; object-fit: cover;">
                <!-- 上传中的加载指示器 -->
                <div id="uploadingIndicator" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
                    <i class="fas fa-spinner fa-spin" style="color: white; font-size: 2em;"></i>
                </div>
            </div>
            <label class="btn btn-outline-primary btn-sm mt-2" style="cursor: pointer;">
                <i class="fas fa-upload"></i> 上传头像
                <input type="file" id="avatarInput" name="avatar" accept=".png,.jpg,.jpeg,.gif,.webp,.bmp,.svg,image/*" style="display:none;" onchange="uploadAvatarInstantly(this)">
            </label>
            <div id="avatarUploadMessage" class="mt-2" style="min-height: 24px;"></div>
        </div>

        <div class="form-group">
            <label class="form-label">用户名</label>
            <input type="text" name="username" class="form-control" value="{{ username }}" placeholder="输入新的用户名">
            <small class="text-muted">修改后会立即生效，需唯一且不少于1个字符</small>
        </div>

        <hr>
        <h5 class="mb-3">修改密码</h5>
        <div class="form-group">
            <label class="form-label">当前密码</label>
            <input type="password" name="current_password" class="form-control" placeholder="输入当前密码">
        </div>
        <div class="form-group">
            <label class="form-label">新密码</label>
            <input type="password" name="new_password" class="form-control" placeholder="新密码不少于6位">
        </div>
        <div class="form-group">
            <label class="form-label">确认新密码</label>
            <input type="password" name="confirm_password" class="form-control" placeholder="再次输入新密码">
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存</button>
            <a href="{{ url_for('logout') }}" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> 退出登录</a>
        </div>
    </form>
</div>

<script>
// 即时上传头像功能
async function uploadAvatarInstantly(input) {
    const file = input.files[0];
    if (!file) return;
    
    const messageDiv = document.getElementById('avatarUploadMessage');
    const avatarImg = document.getElementById('avatarImg');
    const indicator = document.getElementById('uploadingIndicator');
    
    // 获取文件扩展名（更可靠的验证方式）
    const fileName = file.name.toLowerCase();
    const fileExt = fileName.substring(fileName.lastIndexOf('.'));
    const allowedExts = ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.bmp', '.svg'];
    
    // 调试信息
    console.log('上传文件信息:');
    console.log('- 文件名:', file.name);
    console.log('- 扩展名:', fileExt);
    console.log('- MIME类型:', file.type);
    console.log('- 文件大小:', file.size, 'bytes');
    
    // 验证文件扩展名（比MIME类型更可靠）
    if (!allowedExts.includes(fileExt)) {
        messageDiv.innerHTML = `<small class="text-danger">❌ 不支持的文件格式 ${fileExt}，请上传图片文件</small>`;
        input.value = '';
        return;
    }
    
    // 额外验证：如果MIME类型存在但不是图片，也提示
    if (file.type && !file.type.startsWith('image/')) {
        messageDiv.innerHTML = `<small class="text-danger">❌ 文件类型异常 (${file.type})，请确认是图片文件</small>`;
        input.value = '';
        return;
    }
    
    // 验证文件大小（5MB）
    if (file.size > 5 * 1024 * 1024) {
        messageDiv.innerHTML = '<small class="text-danger">❌ 文件过大，请上传小于5MB的图片</small>';
        input.value = '';
        return;
    }
    
    // 显示预览和上传状态
    const reader = new FileReader();
    reader.onload = function(e) {
        avatarImg.src = e.target.result;
    };
    reader.readAsDataURL(file);
    
    // 显示上传中状态
    indicator.style.display = 'flex';
    messageDiv.innerHTML = '<small class="text-info"><i class="fas fa-spinner fa-spin"></i> 正在上传...</small>';
    
    // 创建FormData并上传
    const formData = new FormData();
    formData.append('avatar', file);
    
    try {
        const response = await fetch('/api/upload_avatar', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        indicator.style.display = 'none';
        
        if (data.success) {
            // 上传成功
            messageDiv.innerHTML = `<small class="text-success">✅ ${data.message}</small>`;
            // 更新头像URL（防止缓存）
            if (data.avatar_url) {
                avatarImg.src = data.avatar_url;
            }
            // 3秒后清除消息
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        } else {
            // 上传失败
            messageDiv.innerHTML = `<small class="text-danger">❌ ${data.error}</small>`;
            // 恢复原头像（如果有）
            const originalSrc = avatarImg.getAttribute('data-original');
            if (originalSrc) {
                avatarImg.src = originalSrc;
            }
        }
    } catch (error) {
        indicator.style.display = 'none';
        messageDiv.innerHTML = '<small class="text-danger">❌ 上传失败，请检查网络连接</small>';
        console.error('上传错误:', error);
    }
    
    // 清空input，允许重新上传相同文件
    input.value = '';
}

// 保存原始头像URL
document.addEventListener('DOMContentLoaded', function() {
    const avatarImg = document.getElementById('avatarImg');
    avatarImg.setAttribute('data-original', avatarImg.src);
});
</script>

{% endblock %}

