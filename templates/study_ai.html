{% extends 'base.html' %}

{% block title %}AIåŠ©å­¦ - LovePython{% endblock %}

{% block extra_head %}
<!-- Markdown æ¸²æŸ“åº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- ä»£ç é«˜äº®åº“ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/bash.min.js"></script>
{% endblock %}

{% block content %}
<div class="hero-section mb-4">
    <div class="card">
        <div class="hero-content d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
                <h1 class="display-title mb-2"><i class="fas fa-robot"></i> AIåŠ©å­¦</h1>
                <p class="lead mb-0">åœ¨è¿™é‡Œæé—®ã€è®²è§£æˆ–ç»ƒä¹ ï¼ŒAI ä¼šç»™ä½ å³æ—¶åé¦ˆã€‚</p>
            </div>
            <a href="{{ url_for('study') }}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-arrow-left"></i> è¿”å›å­¦ä¹ ä¸»é¡µ
            </a>
        </div>
    </div>
</div>

<div class="card">
    <div class="chat-container">
        <div class="chat-window" id="chatWindow">
            <div class="chat-message assistant">
                <div class="avatar"><i class="fas fa-robot"></i></div>
                <div class="bubble">
                    ä½ å¥½ï¼Œæˆ‘æ˜¯ AI åŠ©å­¦åŠ©æ‰‹ï¼ˆGLM-4.6V-Flashï¼‰ã€‚æˆ‘å¯ä»¥ï¼š<br>
                    ğŸ’¬ è§£ç­” Python çŸ¥è¯†å’Œç¼–ç¨‹é—®é¢˜<br>
                    ğŸ–¼ï¸ åˆ†æä»£ç æˆªå›¾å’Œå›¾è¡¨<br>
                    ğŸ“‹ <strong>ç›´æ¥ç²˜è´´æˆªå›¾</strong>ï¼ˆCtrl+V æˆ–å³é”®ç²˜è´´ï¼‰<br>
                    ğŸ§  å±•ç¤ºæ€ç»´è¿‡ç¨‹<br>
                    âš¡ å®æ—¶æµå¼å›å¤<br>
                    å¿«æ¥æé—®æˆ–ç²˜è´´æˆªå›¾å§ï¼
                </div>
            </div>
            <!-- è¿™é‡Œåç»­å¯åŠ¨æ€è¿½åŠ èŠå¤©è®°å½• -->
        </div>
        <div class="chat-input">
            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <div id="imagePreview" style="display: none; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <img id="previewImg" style="max-width: 150px; max-height: 150px; border-radius: 6px; object-fit: cover;">
                <button onclick="clearImage()" class="btn btn-sm btn-danger">
                    <i class="fas fa-times"></i> ç§»é™¤
                </button>
            </div>
            
            <textarea id="chatInput" rows="2" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼Œæˆ– Ctrl+V ç²˜è´´æˆªå›¾..." onkeydown="handleKeyDown(event)" onpaste="handlePaste(event)"></textarea>
            
            <div class="chat-actions">
                <!-- å›¾ç‰‡ä¸Šä¼ æŒ‰é’® -->
                <label for="imageUpload" class="btn btn-outline-secondary btn-sm" style="cursor: pointer;" title="ä¸Šä¼ å›¾ç‰‡">
                    <i class="fas fa-image"></i> å›¾ç‰‡
                </label>
                <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                
                <button class="btn btn-primary" type="button" id="sendBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i> å‘é€
                </button>
                <span id="loadingIndicator" class="text-muted" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> AI æ­£åœ¨æ€è€ƒ...
                </span>
            </div>
        </div>
    </div>
</div>

<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .chat-window {
        max-height: 500px;
        min-height: 260px;
        overflow-y: auto;
        padding: 1rem;
        background: var(--gray-100);
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
    }
    .chat-message {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        align-items: flex-start;
    }
    .chat-message .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary-color);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }
    .chat-message.assistant .avatar {
        background: var(--primary-color);
    }
    .chat-message.user .avatar {
        background: var(--success-color);
    }
    .chat-message .bubble {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        max-width: 720px;
        line-height: 1.6;
        box-shadow: var(--box-shadow);
    }
    .chat-message.assistant .bubble {
        background: #fff;
    }
    .chat-message.user {
        flex-direction: row-reverse;
    }
    .chat-message.user .bubble {
        background: #e8f4ff;
        border-color: #cfe2ff;
    }
    .chat-input {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .chat-input textarea {
        width: 100%;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-300);
        padding: 0.75rem 0.9rem;
        resize: vertical;
        min-height: 80px;
        font-size: 1rem;
    }
    .chat-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .chat-actions small {
        color: var(--gray-600);
    }
    @media (max-width: 768px) {
        .chat-window {
            max-height: 360px;
        }
    }
    /* Markdown æ¸²æŸ“æ ·å¼ */
    .chat-message .bubble pre {
        background: #f6f8fa;
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 10px 0;
        border: 1px solid #e1e4e8;
    }
    .chat-message .bubble pre code {
        background: transparent;
        padding: 0;
        border-radius: 0;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.5;
    }
    .chat-message .bubble code {
        background: #f6f8fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
        color: #e01e5a;
    }
    .chat-message .bubble h1,
    .chat-message .bubble h2,
    .chat-message .bubble h3,
    .chat-message .bubble h4,
    .chat-message .bubble h5,
    .chat-message .bubble h6 {
        margin-top: 16px;
        margin-bottom: 8px;
        font-weight: 600;
        line-height: 1.25;
    }
    .chat-message .bubble h1 { font-size: 1.8em; border-bottom: 1px solid #eaecef; padding-bottom: 8px; }
    .chat-message .bubble h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 6px; }
    .chat-message .bubble h3 { font-size: 1.3em; }
    .chat-message .bubble h4 { font-size: 1.1em; }
    .chat-message .bubble h5 { font-size: 1em; }
    .chat-message .bubble h6 { font-size: 0.9em; color: #6a737d; }
    
    .chat-message .bubble ul,
    .chat-message .bubble ol {
        padding-left: 24px;
        margin: 8px 0;
    }
    .chat-message .bubble li {
        margin: 4px 0;
    }
    .chat-message .bubble blockquote {
        border-left: 4px solid #dfe2e5;
        padding-left: 16px;
        margin: 8px 0;
        color: #6a737d;
    }
    .chat-message .bubble table {
        border-collapse: collapse;
        width: 100%;
        margin: 12px 0;
        overflow-x: auto;
        display: block;
    }
    .chat-message .bubble table th,
    .chat-message .bubble table td {
        border: 1px solid #dfe2e5;
        padding: 8px 12px;
        text-align: left;
    }
    .chat-message .bubble table th {
        background: #f6f8fa;
        font-weight: 600;
    }
    .chat-message .bubble table tr:nth-child(even) {
        background: #f6f8fa;
    }
    .chat-message .bubble a {
        color: #0366d6;
        text-decoration: none;
    }
    .chat-message .bubble a:hover {
        text-decoration: underline;
    }
    .chat-message .bubble hr {
        border: 0;
        border-top: 1px solid #e1e4e8;
        margin: 16px 0;
    }
    .chat-message .bubble img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        margin: 8px 0;
    }
    .chat-message .bubble p {
        margin: 8px 0;
        line-height: 1.6;
    }
    .chat-message .bubble strong {
        font-weight: 600;
    }
    .chat-message .bubble em {
        font-style: italic;
    }
</style>

<script>
    // é…ç½® marked.js
    marked.setOptions({
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (err) {}
            }
            return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true
    });
    
    // å­˜å‚¨åŸå§‹å†…å®¹ä»¥ä¾¿å®æ—¶æ¸²æŸ“
    let streamingContent = '';
    
    // æ¸²æŸ“ Markdown å†…å®¹çš„è¾…åŠ©å‡½æ•°
    function renderMarkdown(element, content) {
        try {
            element.innerHTML = marked.parse(content);
            // é«˜äº®æ‰€æœ‰ä»£ç å—
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        } catch (err) {
            console.error('Markdown æ¸²æŸ“é”™è¯¯:', err);
            element.textContent = content;
        }
    }
    
    let currentImage = null;
    let currentVideo = null;
    let currentFile = null;
    
    // å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆé€šç”¨å‡½æ•°ï¼‰
    function loadImageFile(file) {
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
            alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
            return;
        }
        
        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆå»ºè®®å°äº10MBï¼‰
        if (file.size > 10 * 1024 * 1024) {
            alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            currentImage = e.target.result;  // åŒ…å«data:imageå‰ç¼€çš„Base64
            document.getElementById('previewImg').src = currentImage;
            document.getElementById('imagePreview').style.display = 'flex';
        };
        reader.readAsDataURL(file);
    }
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©å™¨ä¸Šä¼ 
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        loadImageFile(file);
    }
    
    // å¤„ç†ç²˜è´´å›¾ç‰‡
    function handlePaste(event) {
        const items = event.clipboardData?.items;
        if (!items) return;
        
        // æŸ¥æ‰¾å›¾ç‰‡é¡¹
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            if (item.type.indexOf('image') !== -1) {
                event.preventDefault(); // é˜»æ­¢é»˜è®¤ç²˜è´´è¡Œä¸º
                const file = item.getAsFile();
                if (file) {
                    loadImageFile(file);
                    // æ˜¾ç¤ºæç¤º
                    const input = document.getElementById('chatInput');
                    const placeholder = input.placeholder;
                    input.placeholder = 'âœ… å›¾ç‰‡å·²ç²˜è´´ï¼ç°åœ¨å¯ä»¥è¾“å…¥é—®é¢˜æˆ–ç›´æ¥å‘é€';
                    setTimeout(() => {
                        input.placeholder = placeholder;
                    }, 2000);
                }
                break;
            }
        }
    }
    
    // æ¸…é™¤å›¾ç‰‡
    function clearImage() {
        currentImage = null;
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imageUpload').value = '';
    }
    
    // æµå¼å‘é€æ¶ˆæ¯
    async function sendMessage() {
        console.log('ğŸ“¤ å‡†å¤‡å‘é€æ¶ˆæ¯...');
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        console.log('æ¶ˆæ¯å†…å®¹:', message);
        console.log('æ˜¯å¦æœ‰å›¾ç‰‡:', !!currentImage);
        
        if (!message && !currentImage && !currentVideo && !currentFile) {
            console.warn('âš ï¸ æ²¡æœ‰å†…å®¹å¯å‘é€');
            alert('è¯·è¾“å…¥é—®é¢˜æˆ–ä¸Šä¼ å›¾ç‰‡');
            return;
        }
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        let userMessage = '';
        if (currentImage) {
            userMessage += `<img src="${currentImage}" style="max-width: 300px; border-radius: 8px; margin-bottom: 8px;"><br>`;
        }
        if (currentVideo) {
            userMessage += `<span class="badge bg-info">ğŸ“¹ è§†é¢‘</span><br>`;
        }
        if (currentFile) {
            userMessage += `<span class="badge bg-secondary">ğŸ“„ æ–‡ä»¶</span><br>`;
        }
        userMessage += message || 'ï¼ˆè¯·åˆ†æä¸Šé¢çš„å†…å®¹ï¼‰';
        
        addMessage(userMessage, true);
        input.value = '';
        
        // ç¦ç”¨å‘é€æŒ‰é’®
        const sendBtn = document.getElementById('sendBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        sendBtn.disabled = true;
        loadingIndicator.style.display = 'inline';
        
        // åˆ›å»ºAIæ¶ˆæ¯æ°”æ³¡
        const chatWindow = document.getElementById('chatWindow');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message assistant';
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        
        // æ€ç»´é“¾å®¹å™¨ï¼ˆå¯æŠ˜å ï¼‰
        const thinkingDiv = document.createElement('div');
        thinkingDiv.style.cssText = 'background: #f0f7ff; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em; color: #666; display: none;';
        thinkingDiv.innerHTML = '<strong>ğŸ¤” æ€è€ƒè¿‡ç¨‹ï¼š</strong><span class="thinking-content"></span>';
        
        // å›å¤å†…å®¹å®¹å™¨
        const contentDiv = document.createElement('div');
        contentDiv.className = 'response-content';
        contentDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨æ€è€ƒ...';
        
        bubble.appendChild(thinkingDiv);
        bubble.appendChild(contentDiv);
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        
        // é‡ç½®æµå¼å†…å®¹
        streamingContent = '';
        
        try {
            // æ„å»ºè¯·æ±‚æ•°æ®
            const requestData = {
                message: message,
                show_thinking: true
            };
            
            if (currentImage) {
                requestData.image = currentImage;
            }
            if (currentVideo) {
                requestData.video = currentVideo;
            }
            if (currentFile) {
                requestData.file = currentFile;
            }
            
            // ä½¿ç”¨æµå¼API
            const response = await fetch('/api/ai/chat/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error('ç½‘ç»œå“åº”å¤±è´¥');
            }
            
            // æ¸…ç©ºåŠ è½½æŒ‡ç¤ºå™¨
            contentDiv.innerHTML = '';
            
            // è¯»å–æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const {done, value} = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, {stream: true});
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            
                            if (data.error) {
                                contentDiv.innerHTML = `<span style="color: red;">âŒ é”™è¯¯: ${data.error}</span>`;
                            } else if (data.reasoning) {
                                // æ˜¾ç¤ºæ€ç»´é“¾
                                thinkingDiv.style.display = 'block';
                                const thinkingContent = thinkingDiv.querySelector('.thinking-content');
                                thinkingContent.textContent += data.reasoning;
                                chatWindow.scrollTop = chatWindow.scrollHeight;
                            } else if (data.content) {
                                // ç´¯ç§¯å†…å®¹
                                streamingContent += data.content;
                                // å®æ—¶æ¸²æŸ“ Markdown
                                renderMarkdown(contentDiv, streamingContent);
                                chatWindow.scrollTop = chatWindow.scrollHeight;
                            } else if (data.done) {
                                console.log('âœ… æµå¼è¾“å‡ºå®Œæˆ');
                            }
                        } catch (e) {
                            console.error('è§£æJSONé”™è¯¯:', e);
                        }
                    }
                }
            }
            
            // æœ€ç»ˆæ¸²æŸ“ï¼ˆç¡®ä¿å®Œæ•´æ¸²æŸ“ï¼‰
            if (streamingContent) {
                renderMarkdown(contentDiv, streamingContent);
            }
            
        } catch (error) {
            contentDiv.innerHTML = `<span style="color: red;">âŒ å‘é€å¤±è´¥ï¼š${error.message || 'ç½‘ç»œé”™è¯¯'}</span><br>
                <small style="color: #666;">è¯·æ£€æŸ¥ï¼š<br>
                1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                2. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨<br>
                3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°äº†è§£è¯¦æƒ…ï¼ˆF12ï¼‰</small>`;
            console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
            console.error('é”™è¯¯å †æ ˆ:', error.stack);
        } finally {
            sendBtn.disabled = false;
            loadingIndicator.style.display = 'none';
            clearImage();
            currentVideo = null;
            currentFile = null;
            input.focus();
        }
    }
    
    function addMessage(content, isUser) {
        const chatWindow = document.getElementById('chatWindow');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = content;
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }
    
    // å¤„ç†æ‹–æ‹½ä¸Šä¼ 
    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        event.dataTransfer.dropEffect = 'copy';
        // æ·»åŠ æ‹–æ‹½æ•ˆæœ
        const chatInput = document.getElementById('chatInput');
        chatInput.style.borderColor = '#0366d6';
        chatInput.style.backgroundColor = '#f0f7ff';
    }
    
    function handleDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        // ç§»é™¤æ‹–æ‹½æ•ˆæœ
        const chatInput = document.getElementById('chatInput');
        chatInput.style.borderColor = '';
        chatInput.style.backgroundColor = '';
    }
    
    function handleDrop(event) {
        event.preventDefault();
        event.stopPropagation();
        
        // ç§»é™¤æ‹–æ‹½æ•ˆæœ
        const chatInput = document.getElementById('chatInput');
        chatInput.style.borderColor = '';
        chatInput.style.backgroundColor = '';
        
        const files = event.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                loadImageFile(file);
                chatInput.placeholder = 'âœ… å›¾ç‰‡å·²æ‹–å…¥ï¼ç°åœ¨å¯ä»¥è¾“å…¥é—®é¢˜æˆ–ç›´æ¥å‘é€';
                setTimeout(() => {
                    chatInput.placeholder = 'è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼Œæˆ– Ctrl+V ç²˜è´´æˆªå›¾...';
                }, 2000);
            } else {
                alert('è¯·æ‹–å…¥å›¾ç‰‡æ–‡ä»¶');
            }
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chatInput');
        chatInput.focus();
        
        // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬
        chatInput.addEventListener('dragover', handleDragOver);
        chatInput.addEventListener('dragleave', handleDragLeave);
        chatInput.addEventListener('drop', handleDrop);
        
        // é˜²æ­¢æ•´ä¸ªçª—å£çš„æ‹–æ”¾
        window.addEventListener('dragover', function(e) {
            e.preventDefault();
        }, false);
        window.addEventListener('drop', function(e) {
            e.preventDefault();
        }, false);
    });
</script>
{% endblock %}

